# Issue -API Implementation
## Post Operation Implementation

1. Checkout the issue-api repository from Git <https://github.com/ANE-UCD-MULESOFT-TRAINING/issue-api> and branch 1.design-and-import. 
  This would get the base code to start the development for this exercise. 
  Import the project into Anypoint Studio by selecting import project, Anypoint studio project. This would open the Mule Project inanypoint studio. 
  Once the project is open, Run the project to check if it loads correctly. This step should download all the dependencies required as well. 
  ![](images/3.1.gif)
  
2. Once the build is complete and you validate that the app is loading correctly, lets perform the next step of adding the modules required for this project. Lets start with       
    importing Mongo DB connector. 
    To do this click on the exchange button 
    Log into anypoint exchange if prompted for login.
    Select Provided by MuleSoft on the left side bar and search for mongodb.
    For this exercise we will use the MongoDB Mule 4 Connector. Now lets select the version 5.4 for this lab exercise.
    Click on Add to project and the connector should be added to the project and you should be able to see that in the Mule Palette.
    ![](images/3.2.gif)
    
3. Now that the dependency is added, lets get started with implementing the Post Issue method. For this we will be reading data from 5 collections (col_lrqi_drivers,   
    col_lrqi_vehicles, col_lrqi_customers, col_lrqi_rate_issue &, col_lrqi_incidents).
    So lets start first by writing the connection to mongodb to fetch data.
    Lets create a new Mule configuration file and name it as policy-api-implementation. We will write all the logic in this file so as to not put lot of logic in one configuration file. Now lets add the first component in this file. From the mule palette add the sub flow component. Inside the sub flow component lets add a mongodb component 'Find one document'.
![](images/3.3.gif)

4. Now that we have added the mongo db component, lets specify the mongo connection string. Click on Add new connector config and select mongo db connection string and provide the connection string. Click on Test connection to validate the connection to mongo is successful.
![](images/3.4.gif)

5. Now lets configure the Find One document. Lets update the collection name to retreive from variable and set it as 
    ```ruby
    vars.query.collectionName
    ```
    also lets update the find query as 
    ```ruby
    vars.query.searchParam
    ```
![](images/3.5.png)

6.  Next lets add a set payload component to the flow after the find one document to save the output from the mongo as Json.
      ```
      %dw 2.0
    output application/json
    ---
    payload
      ```

    ![](images/3.6.png)
 7. Now we are set with the sub flow to connect to mongo DB. Let us create another subflow which will be orchestrating the calls to the mongo db component. For this we will need to connect to 5 different collections, which can be done in parallel and we need not do that sequentially. So lets add another sub flow to policy-api-implementation.xml and in this we will add a scather gather component which would run all the branches of this component in parallel.
  The scather gather will hold two components one would be the set variable and another a flow reference to invoke the mongo connection subflow.
![](images/3.7.gif)

8. Inside the set variable component add the following  
  ```
  output application/json
    ---
    {
      searchParam : {
        quoteId: vars.quoteId
      },
      collectionName: "col_lrqi_drivers"
    }
  ```

![](images/3.8.png)
